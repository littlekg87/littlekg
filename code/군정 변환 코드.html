import pandas as pd
import re

# CSV 파일 경로와 열 이름 지정
input_file_path = r'C:\Users\littl\PycharmProjects\Sejong Records\original data\military data.csv'
column_name = '軍丁 한문_수정'

# 결과를 저장할 파일 경로 지정 (CSV 파일로 저장)
output_file_path = r'C:\Users\littl\PycharmProjects\Sejong Records\original data\military_data_processed.csv'

# 병종 목록
military_types_list = [
    'no_data', '侍衛軍', '守城軍', '守護軍', '巡綽牌', '正軍', '步軍',
    '烟臺軍', '烽火軍', '營屬軍', '營軍', '營鎭屬軍', '營鎭軍', '甲士',
    '翼屬軍', '翼軍', '船軍', '鎭屬軍', '鎭屬防牌', '鎭軍', '長番水軍',
    '防牌', '馬軍', '騎船軍'
]

# 병종 목록을 길이 순으로 내림차순 정렬
military_types_list = sorted(military_types_list, key=len, reverse=True)

# 한자 숫자 변환을 위한 사전
digits = {
    '零': 0, '〇': 0,
    '一': 1, '壹': 1,
    '二': 2, '貳': 2, '兩': 2,
    '三': 3, '參': 3,
    '四': 4, '肆': 4,
    '五': 5, '伍': 5,
    '六': 6, '陸': 6,
    '七': 7, '柒': 7,
    '八': 8, '捌': 8,
    '九': 9, '玖': 9
}

units = {
    '十': 10, '拾': 10,
    '百': 100, '佰': 100,
    '千': 1000, '仟': 1000
}

big_units = {
    '萬': 10000,
    '億': 100000000,
    '兆': 1000000000000
}

def chinese_to_arabic(chinese_numeral):
    """한자 숫자를 아라비아 숫자로 변환하는 함수"""
    if not chinese_numeral:
        return 0

    chinese_numeral = chinese_numeral.replace('單', '')  # '單' 제거
    chinese_numeral = re.sub(r'[^\w一二三四五六七八九零〇十百千萬億兆壹貳參肆伍陸柒捌玖拾佰仟]', '', chinese_numeral)

    total = 0
    section_total = 0  # 작은 단위(萬 미만)의 합계
    number = 0  # 현재 숫자

    i = 0
    while i < len(chinese_numeral):
        char = chinese_numeral[i]
        if char in digits:
            number = digits[char]
        elif char in units:
            unit = units[char]
            if number == 0:
                number = 1  # '十', '百', '千' 앞에 숫자가 없는 경우 1로 간주
            section_total += number * unit
            number = 0
        elif char in big_units:
            unit = big_units[char]
            if number == 0 and section_total == 0:
                section_total = 1  # '萬' 앞에 숫자가 없는 경우 1로 간주
            total += (section_total + number) * unit
            section_total = 0
            number = 0
        else:
            pass  # 기타 문자는 무시
        i += 1

    total += section_total + number
    return total

def extract_military_data(text):
    """텍스트에서 병종과 숫자를 추출하는 함수"""
    if pd.isna(text):
        return {}
    result = {}
    # 문장을 쉼표와 마침표로 분리
    items = re.split(r'[，,。]', text)
    for item in items:
        item = item.strip()
        if not item or item.startswith('軍丁'):
            continue
        # 병종과 숫자 분리
        military_type = None
        for mt in military_types_list:
            if item.startswith(mt):
                military_type = mt
                break
        if military_type:
            number_part = item[len(military_type):]
            # 숫자 부분에서 특수 문자와 '名' 제거
            number_part = re.sub(r'[^\u4e00-\u9fff]', '', number_part)
            # 한자 숫자를 아라비아 숫자로 변환
            number = chinese_to_arabic(number_part)
            result[military_type] = number
    return result

# CSV 파일 읽기
df = pd.read_csv(input_file_path, encoding='utf-8-sig')

# 병종 데이터를 저장할 열을 생성
military_data_list = []

for idx, row in df.iterrows():
    text = row.get(column_name, '')
    military_data = extract_military_data(text)
    military_data_list.append(military_data)

# 병종 리스트를 데이터프레임의 열로 추가
for mt in military_types_list:
    df[mt] = [md.get(mt, 0) for md in military_data_list]

# 결과를 CSV 파일로 저장
df.to_csv(output_file_path, index=False, encoding='utf-8-sig')

print("데이터 처리가 완료되었습니다. 결과가 다음 경로에 저장되었습니다:")
print(output_file_path)
