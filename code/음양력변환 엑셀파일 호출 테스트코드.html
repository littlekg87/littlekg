import pandas as pd
import requests
from xml.etree import ElementTree as ET

# 엑셀 파일 경로 설정
file_path = r'C:\Users\littl\PycharmProjects\Raining Projects\raw data\Raining Records raw data.xlsx'

# 엑셀 파일 읽기
df = pd.read_excel(file_path)

# 서비스 키 설정
decoding_key = '7G1tKWl5lxm8ELpYUwmg/2aFXXZcXGZl1mPeSza4EWSiwlHhkUugDqoG0KUF7/wu99K+Ny/7iutFgVwnmJ1iJg=='

# API 기본 URL 설정
base_url = 'http://apis.data.go.kr/B090041/openapi/service/LrsrCldInfoService/getSpcifyLunCalInfo'

# 변환 결과를 저장할 리스트
converted_dates = []

# 음력 날짜를 변환하여 양력 날짜로 변환하는 루프
for index, row in df.iterrows():
    # 엑셀 데이터에서 필요한 값을 추출
    lun_year = row['연도']
    lun_month = '{:02d}'.format(int(row['월 숫자']))  # 월을 두 자리로 포맷팅
    lun_day = '{:02d}'.format(int(row['일']))  # 일을 두 자리로 포맷팅
    leap_month = row['윤달여부']

    # 매개변수 확인을 위한 디버깅 출력
    print(f"요청 매개변수 - 연도: {lun_year}, 월: {lun_month}, 일: {lun_day}, 윤달 여부: {leap_month}")

    # API 요청 URL 설정
    params = {
        'ServiceKey': decoding_key,  # 디코딩된 서비스 키 사용
        'fromSolYear': lun_year,  # 검색 시작 연도
        'toSolYear': lun_year,    # 검색 종료 연도
        'lunMonth': lun_month,
        'lunDay': lun_day,
        'leapMonth': leap_month  # 윤달 여부 ('평' 또는 '윤')
    }

    response = requests.get(base_url, params=params)

    if response.status_code == 200:
        # XML로 응답이 오므로 XML 파싱 필요
        root = ET.fromstring(response.content)

        # 응답 내용 전체 출력 (디버깅용)
        print("응답 내용:")
        print(response.content.decode('utf-8'))

        # 결과 코드 확인
        result_code = root.find('.//resultCode')
        if result_code is not None and result_code.text == '00':  # 정상 호출
            # items 태그가 비어 있는지 확인
            sol_year = root.find('.//solYear')
            sol_month = root.find('.//solMonth')
            sol_day = root.find('.//solDay')

            if sol_year is not None and sol_month is not None and sol_day is not None:
                converted_dates.append(f"{sol_year.text}-{sol_month.text}-{sol_day.text}")
            else:
                converted_dates.append('데이터 없음')
        else:
            err_msg = root.find('.//errMsg').text if root.find('.//errMsg') is not None else "알 수 없는 오류"
            converted_dates.append(f'API 호출 오류: {err_msg}')
    else:
        converted_dates.append('HTTP 오류 발생: ' + str(response.status_code))

# 변환된 양력 날짜를 새로운 열에 추가
df['양력_날짜'] = converted_dates

# 변환된 데이터 확인
print(df.head())
