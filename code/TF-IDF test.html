import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.cluster import KMeans
import numpy as np
import os

# CSV 파일 로드
data = pd.read_csv('D:/Kunha/PyProjects/Review of Korean History Thesis/Review projects/raw data/한국사연구휘보_20241015135359.csv')

# 논문 제목들을 리스트로 수집
titles = data['제목'].tolist()

# 불용어 리스트 정의
stopwords = ['및', '대한', '으로', '에', '의', '를', '과', '과의', '에의', '을', '에서', '하기', '고찰', '시기', '바탕으로', '역할', '중심으로', '연구', '통해', '의미', '성격', '초기', '분석', '배경과', '관한', '대해', '관련', '사이', '동안', '대비', '때문', '위해', '현상', '상황', '특성', '문제',
             '경우', '필요', '주제', '내용','활동','검토','연구의','특징','전개','양상','재검토','변화']  # 불용어 리스트 확대

# TF-IDF 벡터화
tfidf_vectorizer = TfidfVectorizer(stop_words=stopwords, max_features=1000)
tfidf_matrix = tfidf_vectorizer.fit_transform(titles)

# K-Means 클러스터링
num_clusters = 10  # 분류할 클러스터 수
kmeans = KMeans(n_clusters=num_clusters, random_state=42)
kmeans.fit(tfidf_matrix)

# 각 제목에 할당된 클러스터 출력
data['클러스터'] = kmeans.labels_
print("각 제목에 할당된 클러스터:")
print(data[['제목', '클러스터']])

# 클러스터별 주요 키워드 추출
def get_top_keywords(tfidf_matrix, kmeans, vectorizer, n_terms):
    keywords = []
    centroids = kmeans.cluster_centers_.argsort()[:, ::-1]
    terms = vectorizer.get_feature_names_out()
    for i in range(num_clusters):
        top_keywords = [terms[ind] for ind in centroids[i, :n_terms]]
        keywords.append(", ".join(top_keywords))
    return keywords

num_keywords = 10  # 각 클러스터의 주요 키워드 수
cluster_keywords = get_top_keywords(tfidf_matrix, kmeans, tfidf_vectorizer, num_keywords)
for i, keywords in enumerate(cluster_keywords):
    print(f"클러스터 {i + 1}의 주요 키워드: {keywords}")

# CSV 파일로 저장
# 저장 경로 확인 및 디렉터리 생성
output_dir = 'D:/Kunha/PyProjects/Review of Korean History Thesis/Review projects/output'
os.makedirs(output_dir, exist_ok=True)
output_file = os.path.join(output_dir, '한국사연구휘보_KMeans_결과.csv')
data.to_csv(output_file, index=False, encoding='utf-8-sig')

# 한글 폰트 설정
font_path = 'C:/Windows/Fonts/malgun.ttf'  # Windows 환경에서 Malgun Gothic 폰트 사용
font_prop = fm.FontProperties(fname=font_path)

# 클러스터별 제목 개수 시각화
cluster_counts = data['클러스터'].value_counts().sort_index()
plt.figure(figsize=(10, 6))
plt.bar(cluster_counts.index, cluster_counts.values, color='skyblue')
plt.xlabel('클러스터 번호', fontproperties=font_prop)
plt.ylabel('논문 수', fontproperties=font_prop)
plt.title('클러스터별 논문 수', fontproperties=font_prop)
plt.xticks(cluster_counts.index, [f'클러스터 {i + 1}' for i in cluster_counts.index], fontproperties=font_prop, rotation=45, ha='right')
plt.yticks(fontproperties=font_prop)
plt.show()