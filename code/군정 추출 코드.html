import xml.etree.ElementTree as ET
import re
import pandas as pd

# 한문 숫자 변환 함수
def chinese_to_number(chinese):
    chinese_numbers = {
        '一': 1, '二': 2, '三': 3, '四': 4, '五': 5,
        '六': 6, '七': 7, '八': 8, '九': 9, '零': 0,
        '十': 10, '百': 100, '千': 1000, '萬': 10000
    }

    number = 0
    unit = 1
    num_stack = []

    chinese = chinese.replace('單', '')

    for i, char in enumerate(reversed(chinese)):
        if char in chinese_numbers:
            val = chinese_numbers[char]
            if val == 10 and (i == 0 or chinese_numbers[chinese[-i-1]] >= 10):
                unit *= val
            elif val >= 10:
                if not num_stack:
                    num_stack.append(1)
                unit = val
            else:
                num_stack.append(val * unit)
                unit = 1
        number += sum(num_stack)
        num_stack = []

    number += sum(num_stack)
    return number

# XML 파일 경로
file_path = 'C:\\Users\\littl\\PycharmProjects\\Sejong-Geographical Records\\2nd_wda_400.xml'

# XML 파일 로드
tree = ET.parse(file_path)
root = tree.getroot()

def get_all_text(element):
    """주어진 요소와 모든 하위 요소의 텍스트를 하나로 결합하여 반환합니다."""
    text = element.text or ""
    for subelement in element:
        text += get_all_text(subelement)
        if subelement.tail:
            text += subelement.tail
    return text

# 문장에서 군사 종류와 숫자를 추출하는 함수
def extract_military_data(sentence):
    matches = re.findall(r'(\w+軍)([一二三四五六七八九十百千萬零]+)', sentence)
    return {m[0]: chinese_to_number(m[1]) for m in matches} if matches else {'None': 0}

# 결과를 저장할 리스트
results = []

def extract_sentences(level, element):
    """주어진 레벨과 XML 요소에서 '軍丁' 문장을 추출하여 결과에 추가"""
    for level_element in element.findall(f".//level{level}"):
        level_id = level_element.get('id')
        if level_id and 'wda_400020' <= level_id <= 'wda_400120':
            title = level_element.find('.//mainTitle')
            if title is not None:
                goel = title.text.strip()
                # '地理志 /' 부분 제거
                if '地理志 /' in goel:
                    goel = goel.replace('地理志 /', '').strip()

                content = level_element.find('.//content')
                if content is not None:
                    full_text = get_all_text(content)

                    # '軍丁'으로 시작하고 '。'로 끝나는 문장 추출
                    sentences = re.findall(r'軍丁.*?。', full_text)
                    if sentences:
                        for sentence in sentences:
                            military_data = extract_military_data(sentence)
                            row = [level, level_id, goel, sentence]
                            for military_type, arabic_number in military_data.items():
                                row.append(military_type)
                                row.append(arabic_number)
                            results.append(row)
                    else:
                        results.append([level, level_id, goel, 'no_data', 'None', 0])

# 레벨 3, 4, 5에 대해 문장 추출
for lvl in range(3, 6):
    extract_sentences(lvl, root)

# 결과 출력
for row in results:
    print(row)

# 결과를 데이터프레임으로 변환
columns = ['레벨', '아이디', '고을', '문장']
military_types = set()
for row in results:
    for i in range(4, len(row), 2):
        military_types.add(row[i])

for mtype in military_types:
    columns.append(mtype)

formatted_results = []
for row in results:
    formatted_row = row[:4]
    military_dict = {row[i]: row[i+1] for i in range(4, len(row), 2)}
    for mtype in military_types:
        formatted_row.append(military_dict.get(mtype, 0))
    formatted_results.append(formatted_row)

df = pd.DataFrame(formatted_results, columns=columns)

# CSV 파일로 저장
df.to_csv('C:\\Users\\littl\\PycharmProjects\\Sejong-Geographical Records\\military_sentences3.csv', index=False, encoding='utf-8-sig')
